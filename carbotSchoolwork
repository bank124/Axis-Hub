#include <Servo.h>

// === Motor Pins ===
#define IN1 10
#define IN2 9
#define IN3 2
#define IN4 4
#define ENA 5
#define ENB 6

// === Ultrasonic Pins ===
#define TRIG 13
#define ECHO 12

// === Servo ===
#define SERVO_PIN 8
Servo myServo;

// === Variables ===
int frontDist, leftDist, rightDist;

// === Distance Reading ===
int getDistance() {
  digitalWrite(TRIG, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG, LOW);
  long duration = pulseIn(ECHO, HIGH, 20000);
  int distance = duration * 0.034 / 2;
  if (distance <= 0 || distance > 200) distance = 200;
  return distance;
}

// === Movement Functions ===
void moveForward(int speed) {
  analogWrite(ENA, speed);
  analogWrite(ENB, speed);
  digitalWrite(IN1, LOW);  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW);  digitalWrite(IN4, HIGH);
}

void moveBackward(int speed) {
  analogWrite(ENA, speed);
  analogWrite(ENB, speed);
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void turnLeft(int speed) {
  analogWrite(ENA, speed);
  analogWrite(ENB, speed);
  digitalWrite(IN1, LOW);  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH); digitalWrite(IN4, LOW);
}

void turnRight(int speed) {
  analogWrite(ENA, speed);
  analogWrite(ENB, speed);
  digitalWrite(IN1, HIGH); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);  digitalWrite(IN4, HIGH);
}

void stopCar() {
  analogWrite(ENA, 0);
  analogWrite(ENB, 0);
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
}

// === Scan all directions ===
void scanSurroundings() {
  stopCar();
  delay(200);

  myServo.write(0);   // Left
  delay(400);
  leftDist = getDistance();

  myServo.write(90);  // Front
  delay(400);
  frontDist = getDistance();

  myServo.write(180); // Right
  delay(400);
  rightDist = getDistance();

  myServo.write(90);  // Return to center
  delay(200);

  // Print for debugging
  Serial.print("Left: "); Serial.print(leftDist);
  Serial.print(" | Front: "); Serial.print(frontDist);
  Serial.print(" | Right: "); Serial.println(rightDist);
}

// === Setup ===
void setup() {
  Serial.begin(9600);

  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);
  pinMode(ENA, OUTPUT);
  pinMode(ENB, OUTPUT);
  pinMode(TRIG, OUTPUT);
  pinMode(ECHO, INPUT);

  myServo.attach(SERVO_PIN);

  // Initial test sweep
  myServo.write(0); delay(300);
  myServo.write(90); delay(300);
  myServo.write(180); delay(300);
  myServo.write(90); delay(300);
}

// === Main Loop ===
void loop() {
  scanSurroundings(); // Always scan before deciding

  // === Priority: Left > Right > Forward ===
  if (leftDist > 30) {
    Serial.println("Turning LEFT");
    turnLeft(100); delay(300); stopCar();
     moveBackward(130); delay(200); stopCar();
     turnLeft(100); delay(100); stopCar();
    moveForward(130); delay(500); stopCar();
  }
  else if (rightDist > 30) {
    Serial.println("Turning RIGHT");
    turnRight(100); delay(300); stopCar();
    moveBackward(130); delay(200); stopCar();
    turnRight(100); delay(100); stopCar();
    moveForward(130); delay(500); stopCar();
  }
  else if (frontDist > 10) {
    Serial.println("Going FORWARD");
    moveForward(130); delay(500); stopCar();
  }


  delay(200);
}
